<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø´Ø±Ø§Ø¡</title>
  <link rel="stylesheet" href="../../CSS/checkout.css">
</head>
<body>
  <h1>Ø¥ØªÙ…Ø§Ù… Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø´Ø±Ø§Ø¡</h1>

  <!-- Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ù†ØªØ¬ -->
  <div id="productInfo">
    <p>â³ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬...</p>
  </div>

  <!-- Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª -->
  <form id="orderForm">
    <fieldset>
      <legend>Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙƒ Ø§Ù„Ø´Ø®ØµÙŠØ©</legend>
      <label>Ø§Ø³Ù…Ùƒ Ø§Ù„ÙƒØ§Ù…Ù„:</label>
      <input type="text" name="customer_name" required>

      <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:</label>
      <input type="email" name="customer_email" required>

      <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:</label>
      <input type="tel" name="customer_phone" required>

      <label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙƒØ§Ù…Ù„:</label>
      <textarea name="customer_address" rows="3" required></textarea>
    </fieldset>

    <fieldset>
      <legend>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨</legend>
      <label>Ø§Ù„ÙƒÙ…ÙŠØ©:</label>
      <input type="number" id="quantity" name="quantity" min="1" value="1" required>
    </fieldset>

    <!-- ğŸ‘‡ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚Ø¨Ù„ Ø²Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ -->
    <p id="totalPrice">Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: 0 Ø¯Ø¬</p>

    <button type="submit">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨</button>
  </form>

  <div id="message"></div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const productId = urlParams.get('id');
    const productInfo = document.getElementById('productInfo');
    const form = document.getElementById('orderForm');
    const message = document.getElementById('message');
    const totalPriceEl = document.getElementById('totalPrice');
    const quantityInput = document.getElementById('quantity');
    let currentProduct = null;

    // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬
    async function loadProduct() {
      try {
        const res = await fetch(`/products/${productId}`);
        if (!res.ok) throw new Error("ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù†ØªØ¬");
        const product = await res.json();
        currentProduct = product;

        productInfo.innerHTML = `
          <h2>${product.name}</h2>
          <p>${product.description}</p>
          <p><strong>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„ÙØ±Ø¯ÙŠ:</strong> ${product.price} Ø¯Ø¬</p>
        `;

        updateTotal(); // Ø­Ø³Ø§Ø¨ Ø£ÙˆÙ„ÙŠ Ù„Ù„Ø³Ø¹Ø±
      } catch (err) {
        console.error(err);
        productInfo.innerHTML = "<p>âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬</p>";
      }
    }
    loadProduct();

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„ÙƒÙ…ÙŠØ©
    function updateTotal() {
      if (!currentProduct) return;
      const qty = parseInt(quantityInput.value) || 1;
      const total = qty * currentProduct.price;
      totalPriceEl.textContent = `Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${total} DA`;
    }
    quantityInput.addEventListener("input", updateTotal);

    // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      if (!currentProduct) {
        message.textContent = "âš  Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨ØŒ Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…Ø­Ù…Ù„.";
        message.className = "error";
        return;
      }

      const formData = new FormData(form);
      const data = Object.fromEntries(formData.entries());
      data.product_id = productId;
      data.product_price = currentProduct.price;
      data.total_price = parseInt(quantityInput.value) * currentProduct.price;

      const res = await fetch('/orders', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });

      const result = await res.json();
      if (res.ok) {
        message.textContent = 'âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­';
        message.className = "success";
        form.reset();
        updateTotal();
      } else {
        message.textContent = 'âŒ Ø®Ø·Ø£: ' + (result.error || 'Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±');
        message.className = "error";
      }
    });
  </script>
</body>
</html>
